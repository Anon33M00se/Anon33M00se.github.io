<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=0.5" />
<title>TOTP in the Terminal</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css"/>
                                            <link rel="stylesheet" type="text/css" href="/static/css/customizations.css" />
                                            <link rel="stylesheet" type="text/css" href="/static/css/org-html-styling.css" />
</head>
<body>
<div id="content" class="content">
<header>
  <h1>Stuff</h1>
  <p><i>noun</i> 1. things which need to be put somewhere.</p>
  <div class="topbar-menu-container">
    <span><a href="/index.html">home</a></span> |
    <!--  <span><a href="/enough.html">enough</a></span> | --!>
    <span><a href="/itch.html">itch</a></span> | 
    <span><a href="/email.html">email</a></span> | 
    <span><a href="/totp.html">totp</a></span> | 
    <span><a href="/Books/RootsThatBind/">roots</a></span> | 
    <span><a href="/pta.html">pta</a></span> | 
    <span><a href="/how.html">how?</a></span> 
  </div>
</header>

<div id="outline-container-orgbca7397" class="outline-2">
<h2 id="orgbca7397">TOTP in the Terminal</h2>
<div class="outline-text-2" id="text-orgbca7397">
<p>
Anyone who uses <a href="https://apps.apple.com/us/app/google-authenticator/id388497605">Google Authenticator</a> or <a href="https://2fas.com/">2FAS</a> for "second factor
authentication" knows what Time-based One Time Passwords (TOTP) are. I
used Google Authenticator for years (with redundancy by having it
installed on a couple of different devices). Then, one day, the
Android version on my old Kindle Fire just stopped working:
</p>


<figure id="org11f5de7">
<img src="./static/img/google_none.jpg" alt="google_none.jpg">

</figure>


<p>
Obviously it was time to stop relying on Google Authenticator. And
time to find a solution where I could produce TOTP codes inside a
terminal and understand where all the relevant data was being
stored. Also, since I use <a href="https://www.passwordstore.org/">password-store</a> (sometimes known as gnu-pass)
together with Yubikeys for managing all my other secrets, it would be
great to find an approach that would work closely with that setup.
</p>
</div>
</div>

<div id="outline-container-org080ab6b" class="outline-2">
<h2 id="org080ab6b">Oathtool to the Rescue</h2>
<div class="outline-text-2" id="text-org080ab6b">
<p>
There are a <a href="https://www.cyberciti.biz/faq/use-oathtool-linux-command-line-for-2-step-verification-2fa/">couple</a> of <a href="https://www.nongnu.org/oath-toolkit/oathtool.1.html">resources</a> around that explain how one can
generate TOTP codes at the CLI. They all seem to center on a utility
called oathtool (installed via an oathtool package on virtually all
flavours of Linux).
</p>

<p>
Once I had oathtool installed, I worked up this little bit of a
wrapper script and put it in my .bashrc:
</p>

<div class="org-src-container">
<pre class="src src-code">totp () { 
  if [[ -z $2 ]];
  then 
    oathtool --totp --base32 $(pass TOTP/"$1" | head -n 1) ;
  else
    if [[ $2 == "-c" ]];
    then
      oathtool --totp --base32 $(pass TOTP/"$1"  | head -n 1) | xclip -selection clipboard
      echo "TOTP code has been copied to the clipboard"
    else
      echo "I am confused and do not know what to do !?"
    fi
  fi 
}
</pre>
</div>


<p>
which lets me type:
</p>

<div class="org-src-container">
<pre class="src src-code">totp twilio
</pre>
</div>

<p>
and it will spit back a one time code:
</p>

<div class="org-src-container">
<pre class="src src-code">236018
</pre>
</div>

<p>
or I can just type 
</p>
<div class="org-src-container">
<pre class="src src-code">totp twilio -c
</pre>
</div>

<p>
and it will say:
</p>

<div class="org-src-container">
<pre class="src src-code">TOTP code has been copied to the clipboard
</pre>
</div>

<p>
and copy the one time code to the clipboard.
</p>
</div>
</div>

<div id="outline-container-orgfabef87" class="outline-2">
<h2 id="orgfabef87">Wait, Where do we Get the Original Secrets From?</h2>
<div class="outline-text-2" id="text-orgfabef87">
<p>
If you have a look at that bash function, it's using oathtool to calculate a TOTP from the first line of an entry returned by <b>pass</b>. The <b>pass</b> part of this is just:
</p>

<div class="org-src-container">
<pre class="src src-code">pass TOTP/twilio
</pre>
</div>

<p>
which returns something like:
</p>

<div class="org-src-container">
<pre class="src src-code">XXXXXXXLONG-SECRET-STRINGXXXXXXX

Name:    Twilio
Issuer:  Twilio
Type:    totp
</pre>
</div>

<p>
So, as far as <b>pass</b> is concerned, it's just returning a secret (the
first line above: XXXXXXXLONG-SECRET-STRINGXXXXXXX). Oathtool is then
using that secret, along with the current timestamp, to generate the
one time code. But where does XXXXXXXLONG-SECRET-STRINGXXXXXXX come from?
</p>

<p>
When you ask a website to use TOTP as an authentication mechanism, it
will usually display a QR code (sometimes you can get the secret
directly from copy and paste, but usually it's encoded in the QR
code). You can also have most authenticator apps re-display the QR code
(generally used to back up or migrate codes to a second device).
</p>

<p>
I grab those QR codes in an image and then use a utility available on
github called <a href="https://github.com/scito/extract_otp_secrets">extract_otp_secrets</a>. If you clone that repository, you
can set up a virtual environment like this:
</p>

<div class="org-src-container">
<pre class="src src-code">git clone "https://github.com/scito/extract_otp_secrets.git"
cd extract_otp_secrets/
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt 
</pre>
</div>

<p>
That will pull in everything the utility needs to work. You can then use it like this:
</p>

<div class="org-src-container">
<pre class="src src-code">python src/extract_otp_secrets.py ~/somewhere/a_qr_code.png
</pre>
</div>

<p>
and it will spit out something like:
</p>

<div class="org-src-container">
<pre class="src src-code">Name:    Twilio
Secret:  XXXXXXXLONG-SECRET-STRINGXXXXXXX
Issuer:  Twilio
Type:    totp
</pre>
</div>

<p>
With a bit of editing, you can cut and paste that into a <b>pass</b> entry. Of course you do have to be very careful handling the QR Code images,
deleting them after they have been processed, etc.
</p>
</div>
</div>


<div id="outline-container-org04aa914" class="outline-2">
<h2 id="org04aa914">The Joy of Auto Completion</h2>
<div class="outline-text-2" id="text-org04aa914">
<p>
Since I have a few dozen TOTP-enabled accounts, I don't actually call
them something as short as <b>twilio</b>. I use conventions more like
<b>aws.AccountA@example.com</b>. <b>aws.AccountB@example.com</b>, etc. One of
the great features of <b>pass</b> is that it uses auto completion, so if
you can't remember exactly where in the tree you put your company
credit card password (is that under banking, travel, or work?) you can
<b>TAB</b> your way through to discovering it quickly. And even if you do
know where it is, you can generally get there with a lot fewer
keystrokes.
</p>

<p>
Amazingly, there is an easy way to make tab completion work for my
totp function as well. Well, amazing to me as I've never really
understood the rare incantations related to specifying tab completion
patterns. If you put this:
</p>

<div class="org-src-container">
<pre class="src src-code">#/usr/bin/env bash

&gt;/dev/null pushd "${PASSWORD_STORE_DIR:-$HOME/.password-store}/TOTP"
    l="$(find . -type f | sed s#^./## | sed s#.gpg\$##)"
&gt;/dev/null popd

complete -W "$l" totp
</pre>
</div>

<p>
in:
</p>

<div class="org-src-container">
<pre class="src src-code">/usr/share/bash-completion/completions/totp
</pre>
</div>

<p>
then it will all just automagically work. I don't really understand
the nuances of this, but there is a <a href="https://www.gnu.org/software/bash/manual/html_node/Programmable-Completion.html">guide</a> for more information.
</p>
</div>
</div>


<div id="outline-container-org3ddc648" class="outline-2">
<h2 id="org3ddc648">Update</h2>
<div class="outline-text-2" id="text-org3ddc648">
<p>
A few people have pointed out that there is also <a href="https://github.com/tadfisher/pass-otp">pass-otp</a> project on
github which is another way of going about this.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: February 20, 2025</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 29.3 (<a href="https://orgmode.org">Org</a> mode 9.6.15)</p>
</div>
</body>
</html>
